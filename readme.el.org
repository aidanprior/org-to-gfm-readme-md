:PROPERTIES:
:ID:       3C259707-BB5D-4A47-A77F-01107A2291F3
:END:
#+title: readme.el: Generate Markdown README files from Org documents
#+author: Jeff Kreeftmeijer
#+date: 2023-04-26

A script to generate GitHub-Flavored Markdown files from Org documents, aimed at producing repository README files.

It uses [[https://github.com/larstvei/ox-gfm][ox-gfm]] and [[https://github.com/jeffkreeftmeijer/ox-md-title.el][ox-md-title.el]] to produce GFM files with document titles.
Instead of installing them through a package manager, both packages are vendored in and loaded directly:

#+headers: :tangle readme.el
#+begin_src emacs-lisp
(let ((directory (file-name-directory load-file-name)))
  (load (concat directory "ox-gfm/ox-gfm"))
  (load (concat directory "ox-md-title/ox-md-title")))

(require 'ox-gfm)
(require 'ox-md-title)
(org-md-title-add)
#+end_src

To generate the README, a function named =readme/to-markdown= is exposed:

#+headers: :tangle readme.el
#+begin_src emacs-lisp
  (defun readme/to-markdown (filename)
    (let ((org-md-title t)
	  (make-backup-files nil))
      (org-gfm-export-as-markdown)
      (write-file filename)))
#+end_src

To run the script, run Emacs in =--batch= mode, open the file to be converted to Markdown (=readme.el.org=, in this case), load =readme.el= and call the function with the desired output filename (=README.md=):

#+begin_src shell
  emacs --batch readme.el.org --load readme.el --eval "(readme/to-markdown \"README.md\")"
#+end_src

To automatically generate README files on GitHub, add =readme.el= to your repository and add a workflow that calls it:

#+headers: :tangle .github/workflows/readme.yml
#+begin_src yaml
name: README.md

on:
  push:
    branches: [ "main" ]

jobs:
  generate:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - uses: purcell/setup-emacs@master
        with:
          version: 28.2
      - run: emacs --batch readme.el.org --load readme.el --eval "(readme/to-markdown \"README.md\")"
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Regenerate README.md
#+end_src
